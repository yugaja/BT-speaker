/**
 * @file TFT_24_ST7789.h
 * @brief 320x240 TFT display driver for ST7789 controller (ESP32 Arduino version)
 * @note Fully compatible API with TFT_22_ILI9225 driver
 */

#ifndef _TFT_24_ST7789_H_
#define _TFT_24_ST7789_H_

#include "../core/options.h"
#if DSP_MODEL == DSP_MODEL_ESP32

#include <Arduino.h>
#include <SPI.h>
#include <stdint.h>

/* TFT dimensions */
#define TFT_WIDTH        240
#define TFT_HEIGHT       320

/* Pin definitions */
#define TFT_DC           2
#define TFT_CS           15
#define BRIGHTNESS_PIN   27

/* Basic color definitions */
#define COLOR_BLACK      0x0000
#define COLOR_WHITE      0xFFFF
#define COLOR_RED        0xF800
#define COLOR_GREEN      0x07E0
#define COLOR_BLUE       0x001F
#define COLOR_YELLOW     0xFFE0
#define COLOR_CYAN       0x07FF
#define COLOR_MAGENTA    0xF81F

/* Macro to swap two variables */
#ifndef swap
#define swap(a, b) { int16_t t = a; a = b; b = t; }
#endif

/* MADCTL control bits for orientation */
#define MADCTL_MY  0x80
#define MADCTL_MX  0x40
#define MADCTL_MV  0x20
#define MADCTL_ML  0x10
#define MADCTL_RGB 0x00
#define MADCTL_BGR 0x08
#define MADCTL_MH  0x04

/* RGB565 conversion macro */
#define RGB565(r,g,b)  (((r & 0xF8) << 8) | ((g & 0xFC) << 3) | (b >> 3))

/**
 * @class GFXcanvas16
 * @brief Off-screen canvas for 16-bit color graphics
 * @details Provides a simple buffer that can be drawn to before transferring to TFT.
 */
class GFXcanvas16 {
public:
    uint16_t *buffer;  /**< Pointer to 16-bit pixel buffer */
    uint16_t width;    /**< Canvas width in pixels */
    uint16_t height;   /**< Canvas height in pixels */

    /**
     * @brief Construct a new GFXcanvas16 object
     * @param w Width of the canvas
     * @param h Height of the canvas
     */
    GFXcanvas16(uint16_t w, uint16_t h) {
        width = w;
        height = h;
        buffer = (uint16_t*)malloc(width * height * 2);
    }

    /**
     * @brief Destroy the GFXcanvas16 object and free memory
     */
    ~GFXcanvas16() {
        if (buffer) free(buffer);
    }

    /**
     * @brief Draw a pixel to the canvas
     * @param x X coordinate
     * @param y Y coordinate
     * @param color RGB565 color value
     */
    void drawPixel(int16_t x, int16_t y, uint16_t color) {
        if ((x < 0) || (y < 0) || (x >= width) || (y >= height)) return;
        buffer[y * width + x] = color;
    }

    /**
     * @brief Fill the entire canvas with a color
     * @param color RGB565 color
     */
    void fillScreen(uint16_t color) {
        if (!buffer) return;
        for (uint32_t i = 0; i < (uint32_t)width * height; i++) buffer[i] = color;
    }
};

/**
 * @class TFT_24_ST7789
 * @brief Main display driver class for ST7789 320x240 TFT
 * @details Provides SPI-based control and drawing functions compatible with TFT_22_ILI9225.
 */
class TFT_24_ST7789 {
public:
    TFT_24_ST7789();

    void begin(void);
    void setOrientation(uint8_t orientation);
    void clear(uint16_t color = COLOR_BLACK);
    void drawPixel(uint16_t x, uint16_t y, uint16_t color);
    void fillRectangle(uint16_t x, uint16_t y, uint16_t w, uint16_t h, uint16_t color);
    void drawImage(uint16_t x, uint16_t y, uint16_t w, uint16_t h, const uint16_t *data);
    void setBrightness(uint8_t value);

private:
    void _writeCommand(uint8_t cmd);
    void _writeData(uint8_t data);
    void _writeData16(uint16_t data);
    void _setWindow(uint16_t x0, uint16_t y0, uint16_t x1, uint16_t y1);

    uint16_t _width;
    uint16_t _height;
    uint8_t  _orientation;
};

#endif /* DSP_MODEL_ESP32 */
#endif /* _TFT_24_ST7789_H_ */
